<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>果壳宇宙 | Leo's Blog</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
</head>
<body>

    <header class="header">
        <div class="logo"><a href="index.html">Leo's Blog</a></div>
        <nav class="nav">
            <a href="index.html" class="active">主页</a>
            <a href="#">归档</a>
            <a href="#" onclick="toggleTheme()" title="切换日/夜模式"><i data-feather="moon" id="themeIcon"></i></a>
            <a href="editor.html" class="nav-btn">写文章</a>
        </nav>
    </header>

    <div class="hero">
        <div id="particles-js" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></div>
        
        <div style="position: relative; z-index: 1;">
            <h1>Hey.</h1>
            <p>Finally, I believe that instinction and taste have the power.</p>
        </div>
    </div>

    <div class="search-wrapper">
        <i data-feather="search" class="search-icon"></i>
        <input type="text" class="search-box" id="searchInput" placeholder="搜索宇宙的信号...">
    </div>

    <div class="container">
        <main class="main-content" id="articlesContainer">
            <div style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                <i data-feather="loader" class="spin"></i> 正在连接宇宙信号...
            </div>
        </main>

        <aside class="sidebar">
            <div class="sidebar-widget">
                <h3><i data-feather="user"></i> 关于作者</h3>
                <p style="color: var(--text-secondary); font-size: 0.95rem;">
                    一位曾经信奉玫瑰与星辰的凡人，现在仍然信奉着。
                </p>
            </div>

            <div class="sidebar-widget">
                <h3><i data-feather="tag"></i> 标签云</h3>
                <div class="tags-cloud" id="tagsContainer">
                    </div>
            </div>
        </aside>
    </div>

    <script>
        // --- 1. 核心逻辑 ---
        let allArticles = [];
        let isContentFetched = false; // 标记是否已加载正文供搜索
        const container = document.getElementById('articlesContainer');

        document.addEventListener('DOMContentLoaded', async () => {
            initParticles(); 
            initTheme(); // 初始化暗黑模式
            await loadData(); 
            feather.replace(); 
            
            // 绑定搜索事件
            document.getElementById('searchInput').addEventListener('input', handleSearch);
        });

        // 1.1 初始化暗黑模式
        function initTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            if (isDark) document.body.classList.add('dark-mode');
            updateThemeIcon();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.body.classList.contains('dark-mode') ? 'sun' : 'moon';
            document.getElementById('themeIcon').innerHTML = feather.icons[icon].toSvg();
        }

        // 1.2 加载基础数据
        async function loadData() {
            try {
                const res = await fetch('articles.json');
                if (!res.ok) throw new Error('Network response was not ok');
                
                allArticles = await res.json();
                allArticles.sort((a, b) => new Date(b.date) - new Date(a.date));

                renderTags();
                renderArticles(allArticles);
                
                // 静默预加载所有正文以供搜索
                prefetchContents(); 
            } catch (error) {
                console.error('Fetch error:', error);
                container.innerHTML = `<div style="text-align:center; padding:40px; color:#ef4444;">⚠️ 信号中断</div>`;
            }
        }

        // 1.3 预加载正文 (用于全文搜索)
        async function prefetchContents() {
            const promises = allArticles.map(async (article) => {
                try {
                    const res = await fetch(`Article/${article.file}`);
                    if(res.ok) article.fullContent = await res.text();
                } catch(e) { console.warn('Failed to load content for', article.title); }
            });
            await Promise.all(promises);
            isContentFetched = true;
        }

        // 1.4 处理搜索 (支持标题、标签、正文)
        function handleSearch(e) {
            const term = e.target.value.toLowerCase().trim();
            
            if (!term) {
                renderArticles(allArticles);
                return;
            }

            // 简单的搜索状态提示
            if (!isContentFetched) {
                // 如果正文还没下载完，暂时只搜标题和Tag
                console.log('Searching metadata only (content downloading...)');
            }

            const filtered = allArticles.filter(a => {
                const inTitle = a.title.toLowerCase().includes(term);
                const inTags = (a.tags || []).some(t => t.toLowerCase().includes(term));
                const inExcerpt = (a.excerpt || '').toLowerCase().includes(term);
                const inContent = (a.fullContent || '').toLowerCase().includes(term);
                
                return inTitle || inTags || inExcerpt || inContent;
            });

            renderArticles(filtered, term);
        }

        // 渲染文章卡片
        function renderArticles(articles, highlightTerm = '') {
            container.style.opacity = '0';
            
            if (!articles || articles.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">没有找到相关的信号...</div>';
            } else {
                container.innerHTML = articles.map(article => {
                    const tagsHtml = (article.tags || []).map(tag => `<span class="meta-tag">${tag}</span>`).join('');
                    return `
                        <article class="article-card">
                            <div class="article-meta">
                                <span><i data-feather="calendar" style="width:12px"></i> ${article.date}</span>
                                ${tagsHtml}
                            </div>
                            <h2><a href="article.html?id=${article.id}&file=${article.file}&keyword=${highlightTerm}">${article.title}</a></h2>
                            <p class="article-excerpt">${article.excerpt || '暂无摘要'}</p>
                        </article>
                    `;
                }).join('');
            }
            
            feather.replace();
            setTimeout(() => {
                container.style.transition = 'opacity 0.3s ease';
                container.style.opacity = '1';
            }, 50);
        }

        // 渲染标签云
        function renderTags() {
            const tagsMap = new Map();
            allArticles.forEach(article => {
                (article.tags || []).forEach(tag => {
                    tagsMap.set(tag, (tagsMap.get(tag) || 0) + 1);
                });
            });

            const tagsContainer = document.getElementById('tagsContainer');
            let html = `<span class="tag-item active" onclick="filterArticles('all', this)">全部</span>`;
            tagsMap.forEach((count, tag) => {
                html += `<span class="tag-item" onclick="filterArticles('${tag}', this)">#${tag} <small>(${count})</small></span>`;
            });
            tagsContainer.innerHTML = html;
        }

        // 筛选功能
        window.filterArticles = function(tag, element) {
            document.querySelectorAll('.tag-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('searchInput').value = ''; // 清空搜索框

            if (tag === 'all') {
                renderArticles(allArticles);
            } else {
                const filtered = allArticles.filter(a => a.tags && a.tags.includes(tag));
                renderArticles(filtered);
            }
        };

        // --- 2. 粒子效果配置 ---
        function initParticles() {
            particlesJS('particles-js', {
                "particles": {
                    "number": { "value": 60 },
                    "color": { "value": ["#2563eb", "#64748b"] }, // 适配主题色
                    "shape": { "type": "circle" },
                    "opacity": { "value": 0.5, "random": true },
                    "size": { "value": 3, "random": true },
                    "line_linked": { "enable": true, "distance": 150, "color": "#a1a1aa", "opacity": 0.3, "width": 1 },
                    "move": { "enable": true, "speed": 1 }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": { "onhover": { "enable": true, "mode": "grab" } }
                },
                "retina_detect": true
            });
        }
    </script>
</body>
</html>