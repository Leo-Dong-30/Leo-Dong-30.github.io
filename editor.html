<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>沉浸式写作 - Leo's Editor</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
      /* --- Editor 3.0 变量定义 (支持暗夜模式) --- */
      :root {
        --bg-editor: #f8fafc;
        --bg-panel: #ffffff;
        --text-editor: #334155;
        --text-placeholder: #cbd5e1;
        --border-color: #e2e8f0;
        --scrollbar-thumb: rgba(0, 0, 0, 0.1);
        --scrollbar-hover: rgba(0, 0, 0, 0.2);
        --dock-bg: rgba(255, 255, 255, 0.85);
        --dock-border: rgba(255, 255, 255, 0.5);
      }

      body.dark-mode {
        --bg-editor: #0f172a; /* 深蓝宇宙底色 */
        --bg-panel: #1e293b;
        --text-editor: #94a3b8;
        --text-placeholder: #475569;
        --border-color: #334155;
        --scrollbar-thumb: rgba(255, 255, 255, 0.1);
        --scrollbar-hover: rgba(255, 255, 255, 0.2);
        --dock-bg: rgba(15, 23, 42, 0.8);
        --dock-border: rgba(255, 255, 255, 0.1);
      }

      body {
        overflow: hidden;
        height: 100vh;
        background-color: var(--bg-editor);
        transition: background-color 0.4s ease, color 0.4s ease;
        margin: 0;
      }

      /* --- 布局容器 --- */
      .editor-container {
        display: flex;
        height: 100vh;
        width: 100vw;
        position: relative;
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      }

      /* --- 面板通用样式 --- */
      .pane {
        height: 100%;
        overflow-y: overlay; /* 使用 overlay 让滚动条悬浮在内容之上，不占空间 */
        padding: 60px 60px 140px; /* 增加底部留白 */
        transition: width 0.4s ease, opacity 0.3s ease,
          background-color 0.4s ease;
      }

      /* 极简滚动条逻辑 */
      .pane::-webkit-scrollbar {
        width: 6px; /* 极细 */
        background: transparent;
      }
      .pane::-webkit-scrollbar-thumb {
        background: transparent; /* 平时隐藏 */
        border-radius: 10px;
        transition: background 0.3s;
      }
      .pane:hover::-webkit-scrollbar-thumb {
        background: var(--scrollbar-thumb); /* 悬停显示 */
      }
      .pane::-webkit-scrollbar-thumb:hover {
        background: var(--scrollbar-hover);
      }

      /* 左侧输入区 */
      .write-pane {
        width: 50%;
        background: var(--bg-editor); /* 与背景融合，取消明显的白色块 */
        border-right: 1px solid transparent; /* 移除硬边框，用间距分隔 */
        position: relative;
        z-index: 10;
        /* 右侧加一点内边距，让文字不要贴着中线 */
        padding-right: 40px;
      }

      /* 在双栏模式下，给两个面板中间加一道隐形的分割线 */
      .write-pane::after {
        content: "";
        position: absolute;
        right: 0;
        top: 10%;
        bottom: 10%;
        width: 1px;
        background: var(--border-color);
        opacity: 0.5;
      }

      textarea#markdownInput {
        width: 100%;
        height: 100%;
        border: none;
        resize: none;
        outline: none;
        font-family: "JetBrains Mono", "PingFang SC", sans-serif;
        font-size: 16px;
        line-height: 1.8;
        color: var(--text-editor);
        background: transparent;
      }

      textarea#markdownInput::placeholder {
        color: var(--text-placeholder);
      }

      /* 右侧预览区 */
      .preview-pane {
        width: 50%;
        background: var(--bg-editor);
        padding-left: 40px; /* 左侧加内边距 */
      }

      /* 暗黑模式下的 Markdown 样式适配 */
      body.dark-mode .markdown-body {
        color: #e2e8f0;
      }
      body.dark-mode .markdown-body h1,
      body.dark-mode .markdown-body h2,
      body.dark-mode .markdown-body h3 {
        color: #f1f5f9;
        border-bottom-color: #334155;
      }
      body.dark-mode .markdown-body blockquote {
        background: rgba(37, 99, 235, 0.1);
        color: #93c5fd;
        border-left-color: #3b82f6;
      }
      body.dark-mode .markdown-body code {
        background: rgba(255, 255, 255, 0.1);
        color: #f472b6;
      }
      body.dark-mode .markdown-body pre {
        background: #020617;
      }

      /* --- 禅模式 (Zen Mode) --- */
      body.zen-mode .write-pane {
        width: 100%;
        padding: 60px calc(50vw - 360px) 140px; /* 稍微加宽一点阅读区 */
        border-right: none;
      }
      body.zen-mode .write-pane::after {
        opacity: 0;
      } /* 隐藏中线 */

      body.zen-mode .preview-pane {
        width: 0;
        opacity: 0;
        padding: 0;
        overflow: hidden;
      }

      /* --- 底部悬浮 Dock --- */
      .floating-dock {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dock-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 8px 16px;
        border-radius: 16px; /*稍微方一点，更像现代UI*/
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.15),
          0 0 1px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 8px;
        z-index: 100;
        align-items: center;
        border: 1px solid var(--dock-border);
        transition: all 0.3s ease;
      }

      .dock-item {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-editor);
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
      }

      .dock-item:hover {
        background: var(
          --border-color
        ); /* 使用边框色作为hover背景，自适应深浅 */
        transform: translateY(-3px);
      }

      /* Tooltip */
      .dock-item::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--text-editor);
        color: var(--bg-editor);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        font-weight: 500;
      }
      .dock-item:hover::after {
        opacity: 1;
      }

      .divider {
        width: 1px;
        height: 20px;
        background: var(--border-color);
        margin: 0 6px;
      }

      /* 保存状态指示灯 */
      .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #22c55e; /* Green */
        margin-left: 4px;
        margin-right: 12px;
        transition: background-color 0.3s;
      }
      .status-dot.unsaved {
        background-color: #f59e0b;
      } /* Orange */

      .word-count {
        font-size: 12px;
        color: var(--text-editor);
        opacity: 0.6;
        font-variant-numeric: tabular-nums;
        min-width: 50px;
        text-align: right;
      }

      /* --- 设置抽屉 --- */
      .settings-drawer {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 400px;
        background: var(--bg-panel);
        z-index: 200;
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
        color: var(--text-editor);
      }

      .settings-drawer.active {
        transform: translateX(0);
      }

      .drawer-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .drawer-content {
        padding: 24px;
        overflow-y: auto;
      }

      .form-group label {
        color: var(--text-editor);
        opacity: 0.8;
      }
      .form-control {
        background: var(--bg-editor);
        border-color: var(--border-color);
        color: var(--text-editor);
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(2px);
        z-index: 150;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
    </style>
  </head>
  <body>
    <div class="editor-container" id="editorContainer">
      <div class="pane write-pane" id="writePane">
        <textarea
          id="markdownInput"
          placeholder="# 宇宙的信号...&#10;&#10;开始书写你的故事。"
        ></textarea>
      </div>

      <div class="pane preview-pane" id="previewPane">
        <div id="previewContent" class="markdown-body"></div>
      </div>
    </div>

    <div class="floating-dock">
      <div class="status-dot" id="saveStatus" title="已自动保存"></div>
      <div class="word-count" id="wordCount">0 字</div>

      <div class="divider"></div>

      <div class="dock-item" onclick="toggleZenMode()" data-tooltip="专注模式">
        <i data-feather="monitor" width="18"></i>
      </div>

      <div class="dock-item" onclick="toggleTheme()" data-tooltip="日/夜模式">
        <i data-feather="moon" id="themeIcon" width="18"></i>
      </div>

      <div class="dock-item" onclick="toggleDrawer()" data-tooltip="发布设置">
        <i data-feather="sliders" width="18"></i>
      </div>

      <div class="divider"></div>

      <div
        class="dock-item"
        onclick="downloadMarkdown()"
        data-tooltip="下载 .md"
      >
        <i data-feather="download" width="18"></i>
      </div>
      <div class="dock-item" onclick="exportPDF()" data-tooltip="打印 PDF">
        <i data-feather="printer" width="18"></i>
      </div>

      <div class="divider"></div>

      <!-- 清空草稿按钮 -->
      <div class="dock-item" onclick="clearDraft()" data-tooltip="清空草稿">
        <i data-feather="trash" width="18"></i>
      </div>

      <div class="divider"></div>

      <div
        class="dock-item"
        onclick="window.location.href='index.html'"
        data-tooltip="返回首页"
      >
        <i data-feather="corner-down-left" width="18"></i>
      </div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleDrawer()"></div>

    <div class="settings-drawer" id="settingsDrawer">
      <div class="drawer-header">
        <h2 style="margin: 0; font-size: 1.1rem">Metadata</h2>
        <div
          class="dock-item"
          onclick="toggleDrawer()"
          style="width: 32px; height: 32px; border-radius: 50%"
        >
          <i data-feather="x" width="16"></i>
        </div>
      </div>
      <div class="drawer-content">
        <div class="form-group">
          <label>文章标题 (Title)</label>
          <input
            type="text"
            id="metaTitle"
            class="form-control"
            placeholder="自动读取 H1 或输入..."
          />
        </div>
        <div class="form-group">
          <label>文件名 (File Name)</label>
          <input
            type="text"
            id="metaFile"
            class="form-control"
            placeholder="example.md"
          />
        </div>
        <div class="form-group">
          <label>标签 (Tags)</label>
          <input
            type="text"
            id="metaTags"
            class="form-control"
            placeholder="逗号分隔"
          />
        </div>
        <div class="form-group">
          <label>摘要 (Excerpt)</label>
          <textarea id="metaExcerpt" class="form-control" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label>JSON 配置</label>
          <div
            id="jsonOutput"
            class="json-preview"
            onclick="copyJson()"
            style="
              background: #0f172a;
              padding: 15px;
              border-radius: 8px;
              font-family: monospace;
              font-size: 12px;
              color: #a5b4fc;
              cursor: pointer;
            "
          ></div>
          <p
            style="
              text-align: right;
              font-size: 12px;
              color: var(--text-editor);
              margin-top: 5px;
              opacity: 0.6;
            "
          >
            点击复制
          </p>
        </div>
      </div>
    </div>

    <script>
      feather.replace();

      // --- DOM 元素 ---
      const input = document.getElementById("markdownInput");
      const preview = document.getElementById("previewContent");
      const wordCountEl = document.getElementById("wordCount");
      const saveStatus = document.getElementById("saveStatus");
      const writePane = document.getElementById("writePane");
      const previewPane = document.getElementById("previewPane");

      // --- 1. 初始化 & 本地存储 (Local Storage) ---
      const STORAGE_KEY = "leo_blog_draft";

      function loadDraft() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          input.value = data.content || "";
          document.getElementById("metaTitle").value = data.title || "";
          document.getElementById("metaFile").value = data.file || "";
          document.getElementById("metaTags").value = data.tags || "";
          document.getElementById("metaExcerpt").value = data.excerpt || "";

          // 恢复主题
          if (data.darkMode) {
            document.body.classList.add("dark-mode");
            document.getElementById("themeIcon").innerHTML =
              feather.icons.sun.toSvg({ width: 18 });
          }
        } else {
          // 默认欢迎语
          input.value =
            "# Hello World\n\n欢迎来到沉浸式编辑器。\n\n* **自动保存**: 你的文字会实时保存在本地。\n* **同步滚动**: 左侧写作，右侧预览智能跟随。\n* **专注模式**: 点击底部白板图标。\n* **暗夜模式**: 点击底部月亮图标。\n* **导出功能**: 支持Markdown和PDF格式导出。\n\n> Stay hungry, stay foolish.";
        }
        update();
      }

      function saveDraft() {
        // 视觉反馈：变为黄色（未保存/正在保存）
        saveStatus.classList.add("unsaved");

        const data = {
          content: input.value,
          title: document.getElementById("metaTitle").value,
          file: document.getElementById("metaFile").value,
          tags: document.getElementById("metaTags").value,
          excerpt: document.getElementById("metaExcerpt").value,
          darkMode: document.body.classList.contains("dark-mode"),
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        // 延迟一下变回绿色，模拟保存完成
        setTimeout(() => {
          saveStatus.classList.remove("unsaved");
        }, 500);
      }

      // --- 2. 实时渲染 & 核心逻辑 ---
      function update() {
        const text = input.value;
        preview.innerHTML = marked.parse(text);

        // 字数统计
        const cleanText = text.replace(/[#*`~>\[\]\(\)\n-]/g, "").trim();
        wordCountEl.innerText = `${cleanText.length} 字`;

        // 更新 JSON（如果抽屉开着）
        if (
          document.getElementById("settingsDrawer").classList.contains("active")
        ) {
          generateJson();
        }
      }

      // 输入监听：更新UI + 触发保存
      input.addEventListener("input", () => {
        update();
        saveDraft();
      });

      // 元数据输入监听
      ["metaTitle", "metaFile", "metaTags", "metaExcerpt"].forEach((id) => {
        document.getElementById(id).addEventListener("input", saveDraft);
        document.getElementById(id).addEventListener("input", generateJson);
      });

      // --- 3. 同步滚动 (Sync Scroll) ---
      let isScrolling = false;
      let activePane = null; // 'left' or 'right'

      // 鼠标移入哪个区域，哪个区域就是主动滚动方
      writePane.addEventListener("mouseenter", () => {
        activePane = "left";
      });
      previewPane.addEventListener("mouseenter", () => {
        activePane = "right";
      });

      writePane.addEventListener("scroll", (e) => {
        if (activePane !== "left") return;
        if (!isScrolling) {
          window.requestAnimationFrame(() => {
            const percentage =
              writePane.scrollTop /
              (writePane.scrollHeight - writePane.clientHeight);
            previewPane.scrollTop =
              percentage *
              (previewPane.scrollHeight - previewPane.clientHeight);
          });
        }
      });

      previewPane.addEventListener("scroll", (e) => {
        if (activePane !== "right") return;
        if (!isScrolling) {
          window.requestAnimationFrame(() => {
            const percentage =
              previewPane.scrollTop /
              (previewPane.scrollHeight - previewPane.clientHeight);
            writePane.scrollTop =
              percentage * (writePane.scrollHeight - writePane.clientHeight);
          });
        }
      });

      // --- 4. 功能切换 ---

      // 暗夜模式
      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        const icon = document.getElementById("themeIcon");
        const isDark = document.body.classList.contains("dark-mode");

        // 切换图标
        icon.innerHTML = isDark
          ? feather.icons.sun.toSvg({ width: 18 })
          : feather.icons.moon.toSvg({ width: 18 });

        saveDraft(); // 保存主题偏好
      }

      // 禅模式
      function toggleZenMode() {
        document.body.classList.toggle("zen-mode");
      }

      // 抽屉开关
      function toggleDrawer() {
        const drawer = document.getElementById("settingsDrawer");
        const overlay = document.getElementById("overlay");
        drawer.classList.toggle("active");
        overlay.classList.toggle("active");
        if (drawer.classList.contains("active")) generateJson();
      }

      // JSON 生成逻辑
      function generateJson() {
        const title = document.getElementById("metaTitle").value || "未命名";
        const file =
          document.getElementById("metaFile").value || "undefined.md";
        const tags = document
          .getElementById("metaTags")
          .value.split(/[,，]/)
          .map((t) => t.trim())
          .filter((t) => t);
        const excerpt = document.getElementById("metaExcerpt").value || "";
        const id = file.replace(".md", "");

        // 如果未填写标题，尝试取 H1
        let finalTitle = title;
        if (title === "未命名") {
          const firstLine = input.value.split("\n")[0];
          if (firstLine && firstLine.startsWith("# ")) {
            finalTitle = firstLine.replace("# ", "").trim();
          }
        }

        const data = {
          id,
          file,
          title: finalTitle,
          date: new Date().toISOString().split("T")[0],
          tags,
          excerpt,
        };
        document.getElementById("jsonOutput").innerText =
          JSON.stringify(data, null, 4) + ",";
      }

      function copyJson() {
        const text = document.getElementById("jsonOutput").innerText;
        navigator.clipboard.writeText(text).then(() => {
          const el = document.getElementById("jsonOutput");
          const originalColor = el.style.color;
          el.style.color = "#4ade80"; // Green flash
          setTimeout(() => (el.style.color = originalColor), 500);
        });
      }

      // 清空草稿功能
      function clearDraft() {
        // 清空文本输入框内容
        input.value = "";

        // 清空元数据输入框
        document.getElementById("metaTitle").value = "";
        document.getElementById("metaFile").value = "";
        document.getElementById("metaTags").value = "";
        document.getElementById("metaExcerpt").value = "";

        // 清空预览区域
        preview.innerHTML = "";

        // 清除本地存储中的草稿
        localStorage.removeItem(STORAGE_KEY);

        // 更新字数显示
        wordCountEl.innerText = "0 字";

        // 清除保存状态指示灯
        saveStatus.classList.remove("unsaved");
      }

      // --- 5. 图片拖拽/粘贴 (复用原有逻辑) ---
      function insertAtCursor(text) {
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const val = input.value;
        input.value = val.substring(0, start) + text + val.substring(end);
        input.selectionStart = input.selectionEnd = start + text.length;
        update();
        saveDraft();
      }

      function handleImage(file) {
        const fileName =
          document.getElementById("metaFile").value.replace(".md", "") ||
          "temp";
        const mdPath = `Article/image/${fileName}/${file.name}`;
        insertAtCursor(`\n![${file.name}](${mdPath})\n`);

        // 实时预览 Blob
        const blobURL = URL.createObjectURL(file);
        setTimeout(() => {
          const imgs = preview.querySelectorAll(`img[src="${mdPath}"]`);
          imgs.forEach((img) => (img.src = blobURL));
        }, 100);
      }

      document.addEventListener("paste", (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (const item of items) {
          if (item.kind === "file") {
            e.preventDefault();
            handleImage(item.getAsFile());
          }
        }
      });

      input.addEventListener("dragover", (e) => e.preventDefault());
      input.addEventListener("drop", (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        for (const file of files) {
          if (file.type.startsWith("image/")) handleImage(file);
        }
      });

      // --- 6. 导出 ---
      function downloadMarkdown() {
        const blob = new Blob([input.value], { type: "text/markdown" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = document.getElementById("metaFile").value || "draft.md";
        link.click();
      }

      function exportPDF() {
        const element = document
          .getElementById("previewContent")
          .cloneNode(true);
        const title = document.getElementById("metaTitle").value || "Document";

        // 简单的 PDF 包装样式
        const wrapper = document.createElement("div");
        wrapper.style.padding = "40px";
        wrapper.style.fontFamily = "serif";
        wrapper.style.color = "#000"; // 强制黑色
        wrapper.innerHTML = `<h1 style="text-align:center; margin-bottom:40px;">${title}</h1>`;
        wrapper.appendChild(element);

        html2pdf()
          .set({
            margin: 10,
            filename: `${title}.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          })
          .from(wrapper)
          .save();
      }

      // 启动
      loadDraft();
    </script>
  </body>
</html>
