<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章编辑 - Leo's Blog</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo"><a href="index.html">Leo's Blog</a></div>
        <nav class="nav">
            <a href="index.html">主页</a>
            <a href="#">归档</a>
            <a href="#">关于我</a>
            <a href="#">联系</a>
        </nav>
    </div>

    <div class="editor-container">
        <div class="editor-header">
            <div>
                <div class="file-input-wrapper">
                    <button class="btn btn-secondary">选择本地文章</button>
                    <input type="file" id="fileSelector" accept=".md" />
                </div>
            </div>
            <div>
                <input type="text" id="fileNameInput" placeholder="输入文件名（如：3.md）" value="new-article.md" 
                       style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                <button id="saveBtn" class="btn btn-primary">保存文章</button>
            </div>
        </div>

        <div class="editor-content">
            <div class="editor-input">
                <textarea id="markdownInput" placeholder="请输入Markdown内容...
示例格式：
# 文章标题
> 文章摘要（可选）
## 一、引言
这是文章正文，支持Markdown语法：
- 列表
- 图片：![描述](图片URL)
- 链接：[文本](URL)
- 代码：`console.log('hello')`
"></textarea>
            </div>
            <div class="editor-preview" id="previewContainer"></div>
        </div>
    </div>

    <script>
        const markdownInput = document.getElementById('markdownInput');
        const previewContainer = document.getElementById('previewContainer');
        const fileSelector = document.getElementById('fileSelector');
        const saveBtn = document.getElementById('saveBtn');
        const fileNameInput = document.getElementById('fileNameInput');

        // 1. 实时预览Markdown
        function updatePreview() {
            const markdownContent = markdownInput.value;
            const htmlContent = marked.parse(markdownContent);
            previewContainer.innerHTML = htmlContent;
        }

        markdownInput.addEventListener('input', updatePreview);

        // 2. 读取本地Markdown文件（保留原有创建时间注释）
        fileSelector.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.type !== 'text/markdown' && !file.name.endsWith('.md')) {
                alert('请选择.md格式的Markdown文件');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                markdownInput.value = content; // 直接保留原内容（包括创建时间注释）
                fileNameInput.value = file.name;
                updatePreview();
            };
            reader.readAsText(file);
        });

        // 3. 保存文章（新建文章时自动添加创建时间注释）
        saveBtn.addEventListener('click', function() {
            let markdownContent = markdownInput.value.trim();
            const fileName = fileNameInput.value.trim();

            if (!markdownContent) {
                alert('文章内容不能为空！');
                return;
            }
            if (!fileName.endsWith('.md')) {
                alert('文件名必须以.md结尾（如：my-article.md）');
                return;
            }

            // 关键：如果是新建文章（内容中没有创建时间注释），自动添加
            const createTimeRegex = /<!--\s*createTime:\s*\d{4}-\d{2}-\d{2}\s*-->/;
            if (!createTimeRegex.test(markdownContent)) {
                // 生成当前日期（YYYY-MM-DD）作为创建时间
                const today = new Date().toISOString().split('T')[0];
                // 在文章开头添加注释（不影响内容显示）
                markdownContent = `<!-- createTime: ${today} -->\n\n` + markdownContent;
            }

            // 创建文件并下载
            const blob = new Blob([markdownContent], { type: 'text/markdown; charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('文章保存成功！请将文件移动到 Article 目录下');
            }, 100);
        });

        // 初始化预览
        updatePreview();
    </script>
</body>
</html>