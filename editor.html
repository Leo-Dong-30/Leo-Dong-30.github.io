<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>沉浸式写作 - Leo's Editor</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  </head>
  <body>
    <div class="editor-container" id="editorContainer">
      <div class="pane write-pane no-scrollbar" id="writePane">
        <textarea id="markdownInput" placeholder="# 宇宙的信号...&#10;&#10;开始书写你的故事。"></textarea>
      </div>

      <div class="pane preview-pane no-scrollbar" id="previewPane">
        <div id="previewContent" class="markdown-body"></div>
      </div>
    </div>

    <div class="floating-dock">
      <div class="status-dot" id="saveStatus" title="已自动保存"></div>
      <div class="word-count" id="wordCount">0 字</div>

      <div class="divider"></div>

      <div class="dock-item" onclick="Editor.toggleZenMode()" data-tooltip="专注模式">
        <i data-feather="monitor" width="18"></i>
      </div>
      <div class="dock-item" onclick="Editor.toggleTheme()" data-tooltip="日/夜模式">
        <i data-feather="moon" id="themeIcon" width="18"></i>
      </div>
      <div class="dock-item" onclick="Editor.toggleDrawer()" data-tooltip="发布设置">
        <i data-feather="sliders" width="18"></i>
      </div>

      <div class="divider"></div>

      <div class="dock-item" onclick="Editor.exportMarkdown()" data-tooltip="下载 .md">
        <i data-feather="download" width="18"></i>
      </div>
      <div class="dock-item" onclick="Editor.exportPDF()" data-tooltip="打印 PDF">
        <i data-feather="printer" width="18"></i>
      </div>

      <div class="divider"></div>

      <div class="dock-item" onclick="Editor.clearDraft()" data-tooltip="清空草稿">
        <i data-feather="trash" width="18"></i>
      </div>

      <div class="divider"></div>

      <div class="dock-item" onclick="window.location.href='index.html'" data-tooltip="返回首页">
        <i data-feather="corner-down-left" width="18"></i>
      </div>
    </div>

    <div class="overlay" id="overlay" onclick="Editor.toggleDrawer()"></div>

    <div class="settings-drawer" id="settingsDrawer">
      <div class="drawer-header">
        <h2 style="margin: 0; font-size: 1.1rem">Metadata</h2>
        <div class="dock-item" onclick="Editor.toggleDrawer()" style="width: 32px; height: 32px; border-radius: 50%">
          <i data-feather="x" width="16"></i>
        </div>
      </div>
      <div class="drawer-content">
        <div class="form-group">
          <label>文章标题 (Title)</label>
          <input type="text" id="metaTitle" class="form-control" placeholder="自动读取 H1 或输入..." />
        </div>
        <div class="form-group">
          <label>文件名 (File Name)</label>
          <input type="text" id="metaFile" class="form-control" placeholder="example.md" />
        </div>
        <div class="form-group">
          <label>标签 (Tags)</label>
          <input type="text" id="metaTags" class="form-control" placeholder="逗号分隔" />
        </div>
        <div class="form-group">
          <label>摘要 (Excerpt)</label>
          <textarea id="metaExcerpt" class="form-control" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label>JSON 配置 (点击复制)</label>
          <div id="jsonOutput" onclick="Editor.copyJson()"></div>
        </div>
      </div>
    </div>

    <script>
      /**
       * Editor 逻辑命名空间
       */
      const Editor = (() => {
        const STORAGE_KEY = "leo_blog_draft";
        const DOM = {
            input: document.getElementById("markdownInput"),
            preview: document.getElementById("previewContent"),
            writePane: document.getElementById("writePane"),
            wordCount: document.getElementById("wordCount"),
            saveStatus: document.getElementById("saveStatus"),
            drawer: document.getElementById("settingsDrawer"),
            overlay: document.getElementById("overlay"),
            themeIcon: document.getElementById("themeIcon"),
            jsonOutput: document.getElementById("jsonOutput"),
            metaInputs: ["metaTitle", "metaFile", "metaTags", "metaExcerpt"].map(id => document.getElementById(id))
        };
        
        // --- 初始化 ---
        function init() {
            feather.replace();
            loadDraft(); // 加载草稿 & 设置主题
            setupEventListeners();
        }

        // --- 1. 数据存取 (Local Storage) ---
        function loadDraft() {
            const saved = localStorage.getItem(STORAGE_KEY);
            // 优先读取全局主题设置，如果没有则看草稿，默认日间
            const globalTheme = localStorage.getItem('theme');
            const isDark = globalTheme === 'dark';
            
            if (isDark) {
                document.body.classList.add("dark-mode");
            } else {
                document.body.classList.remove("dark-mode");
            }
            updateThemeIcon();

            if (saved) {
                const data = JSON.parse(saved);
                DOM.input.value = data.content || "";
                DOM.metaInputs[0].value = data.title || "";
                DOM.metaInputs[1].value = data.file || "";
                DOM.metaInputs[2].value = data.tags || "";
                DOM.metaInputs[3].value = data.excerpt || "";
            } else {
                DOM.input.value = "# Hello World\n\n欢迎使用沉浸式编辑器。\n\n* **极简模式**: 已隐藏烦人的滚动条，您可以自由滑动鼠标滚轮。\n* **独立滚动**: 左右视图不再强制同步，随心查阅。";
            }
            updatePreview();
        }

        function saveDraft() {
            DOM.saveStatus.classList.add("unsaved"); 
            
            const data = {
                content: DOM.input.value,
                title: DOM.metaInputs[0].value,
                file: DOM.metaInputs[1].value,
                tags: DOM.metaInputs[2].value,
                excerpt: DOM.metaInputs[3].value,
                // 主题不再保存在草稿里，而是全局 localstorage
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

            setTimeout(() => DOM.saveStatus.classList.remove("unsaved"), 500); 
        }

        // --- 2. 核心渲染 ---
        function updatePreview() {
            const text = DOM.input.value;
            DOM.preview.innerHTML = marked.parse(text);
            
            // 字数统计
            const cleanText = text.replace(/[#*`~>\[\]\(\)\n-]/g, "").trim();
            DOM.wordCount.innerText = `${cleanText.length} 字`;
            
            if (DOM.drawer.classList.contains("active")) {
                generateJson();
            }
        }

        // --- 3. 事件监听 ---
        function setupEventListeners() {
            DOM.input.addEventListener("input", () => {
                updatePreview();
                saveDraft();
            });
            
            DOM.metaInputs.forEach(el => el.addEventListener("input", () => {
                saveDraft();
                generateJson();
            }));

            // 注意：已移除滚动同步监听器，实现独立滚动
            
            setupImageHandling();
        }

        function setupImageHandling() {
            const insertImage = (file) => {
                const folder = DOM.metaInputs[1].value.replace(".md", "") || "temp";
                const mdText = `\n![${file.name}](Article/image/${folder}/${file.name})\n`;
                
                const start = DOM.input.selectionStart;
                DOM.input.value = DOM.input.value.substring(0, start) + mdText + DOM.input.value.substring(DOM.input.selectionEnd);
                
                const blobURL = URL.createObjectURL(file);
                setTimeout(() => {
                    const imgs = DOM.preview.querySelectorAll(`img[src*="${file.name}"]`);
                    imgs.forEach(img => img.src = blobURL);
                }, 100);
                
                updatePreview();
                saveDraft();
            };

            document.addEventListener("paste", (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let item of items) {
                    if (item.kind === "file" && item.type.startsWith("image/")) {
                        e.preventDefault();
                        insertImage(item.getAsFile());
                    }
                }
            });
        }

        // --- 4. 公共 API ---
        return {
            init,
            
            toggleTheme: () => {
                document.body.classList.toggle("dark-mode");
                localStorage.setItem('theme', document.body.classList.contains("dark-mode") ? 'dark' : 'light');
                updateThemeIcon();
            },
            
            toggleZenMode: () => {
                document.body.classList.toggle("zen-mode");
            },
            
            toggleDrawer: () => {
                DOM.drawer.classList.toggle("active");
                DOM.overlay.classList.toggle("active");
                if (DOM.drawer.classList.contains("active")) generateJson();
            },

            clearDraft: () => {
                if(!confirm("确定要清空所有内容吗？")) return;
                DOM.input.value = "";
                DOM.metaInputs.forEach(input => input.value = "");
                localStorage.removeItem(STORAGE_KEY);
                updatePreview();
            },

            copyJson: () => {
                const text = DOM.jsonOutput.innerText;
                navigator.clipboard.writeText(text).then(() => {
                    DOM.jsonOutput.style.color = "#4ade80"; 
                    setTimeout(() => DOM.jsonOutput.style.color = "#a5b4fc", 500);
                });
            },

            exportMarkdown: () => {
                const blob = new Blob([DOM.input.value], { type: "text/markdown" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = DOM.metaInputs[1].value || "draft.md";
                link.click();
            },

            exportPDF: () => {
                const title = DOM.metaInputs[0].value || "Document";
                const wrapper = document.createElement("div");
                wrapper.className = "pdf-export-wrapper";
                wrapper.innerHTML = `<h1>${title}</h1>` + DOM.preview.innerHTML;
                
                html2pdf().set({
                    margin: 10,
                    filename: `${title}.pdf`,
                    image: { type: "jpeg", quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
                }).from(wrapper).save();
            }
        };

        // --- 辅助函数 ---
        function updateThemeIcon() {
            const isDark = document.body.classList.contains("dark-mode");
            DOM.themeIcon.innerHTML = feather.icons[isDark ? "sun" : "moon"].toSvg({ width: 18 });
        }

        function generateJson() {
            const title = DOM.metaInputs[0].value || "未命名";
            let finalTitle = title;
            
            if (title === "未命名") {
                const firstLine = DOM.input.value.split("\n")[0];
                if (firstLine?.startsWith("# ")) finalTitle = firstLine.replace("# ", "").trim();
            }

            const data = {
                id: DOM.metaInputs[1].value.replace(".md", "") || "undefined",
                file: DOM.metaInputs[1].value || "undefined.md",
                title: finalTitle,
                date: new Date().toISOString().split("T")[0],
                tags: DOM.metaInputs[2].value.split(/[,，]/).map(t => t.trim()).filter(Boolean),
                excerpt: DOM.metaInputs[3].value || ""
            };
            DOM.jsonOutput.innerText = JSON.stringify(data, null, 4) + ",";
        }
      })();

      Editor.init();
    </script>
  </body>
</html>